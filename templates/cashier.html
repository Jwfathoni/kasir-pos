{% extends "layout.html" %}
{% block content %}
{% if error %}<div class="alert">{{ error }}</div>{% endif %}
<div class="welcome-message">
  <div>Selamat datang, <b>{{ user.display_name if user.display_name else user.username }}</b>!</div>
  <div class="current-time" id="current-time-display" style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 8px;"></div>
</div>
<div class="grid2">
  <div class="card">
    <h2>ğŸ“¦ Produk</h2>
    <input id="search" placeholder="ğŸ” Ketik untuk mencari produk..." oninput="filterProducts()" style="font-size: 1rem;">
    <div style="margin-bottom: 10px; font-size: 0.85rem; color: #b0b0b0;">
      <span id="cashier-product-hint">Ketik untuk menampilkan produk</span>
    </div>
    <div id="productList" class="plist" style="display: none;">
      {% for p in products %}
      <button class="pitem" onclick='addToCart("{{p.code}}","{{p.name}}",{{p.price}})'>
        <b>{{ p.name }}</b><br>
        <small>{{ p.code }} â€¢ Rp {{ p.price | format_idr }} â€¢ Stok: {{ p.stock }}</small>
      </button>
      {% endfor %}
    </div>
  </div>

  <div class="card">
    <h2>ğŸ›’ Keranjang</h2>
    <div id="cart"></div>
    <div class="total">
      <div>Total: <b id="total">0</b></div>
    </div>

    <form method="post" action="/checkout" onsubmit="submitCheckout(event); return false;">
      <input type="hidden" name="cart_json" id="cart_json">
      <label>Metode bayar</label>
      <select name="payment_method">
        <option value="cash">ğŸ’° Tunai</option>
        <option value="qris">ğŸ“± QRIS</option>
        <option value="transfer">ğŸ¦ Transfer</option>
      </select>

      <label>Bayar</label>
      <input name="paid" id="paid" type="text" step="0.01" value="0" required onkeyup="formatInputRupiah(this)" onblur="formatInputRupiah(this)" onfocus="unformatInputRupiah(this)" data-original-type="number">

      <div class="form-actions">
        <button type="submit">ğŸ’¾ Simpan & Print Struk</button>
        <button type="button" class="danger" onclick="clearCart()">ğŸ—‘ï¸ Clear</button>
      </div>
    </form>
  </div>
</div>

<script>
// Update waktu real-time dengan timezone dari server
function updateCurrentTime() {
  fetch('/api/timezone-info')
    .then(response => response.json())
    .then(data => {
      const timeDisplay = document.getElementById('current-time-display');
      if (timeDisplay) {
        // Tampilkan dengan format lokal Indonesia
        const localFormatter = new Intl.DateTimeFormat('id-ID', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          hour12: false
        });
        
        const now = new Date();
        const displayTime = localFormatter.format(now);
        timeDisplay.textContent = displayTime + ' (' + data.timezone + ')';
      }
    })
    .catch(err => console.error('Error fetching timezone:', err));
}

// Update waktu saat halaman load dan setiap detik
if (document.getElementById('current-time-display')) {
  updateCurrentTime();
  setInterval(updateCurrentTime, 1000);
}
</script>
{% endblock %}

