{% extends "layout.html" %}
{% block content %}
<div class="card">
  <h2>âš™ï¸ Pengaturan Toko</h2>
  {% if request.query_params.get("msg") == "updated" %}
    <div class="alert" style="background: linear-gradient(135deg, rgba(76, 175, 80, 0.2) 0%, rgba(67, 160, 71, 0.2) 100%); border-color: rgba(76, 175, 80, 0.4); color: #a5d6a7;">Pengaturan berhasil disimpan!</div>
  {% endif %}
  {% if request.query_params.get("msg") == "imported" %}
    <div class="alert" style="background: linear-gradient(135deg, rgba(76, 175, 80, 0.2) 0%, rgba(67, 160, 71, 0.2) 100%); border-color: rgba(76, 175, 80, 0.4); color: #a5d6a7;">Database berhasil diimport!</div>
  {% endif %}
  {% if request.query_params.get("msg") == "database_cleared" %}
    <div class="alert" style="background: linear-gradient(135deg, rgba(76, 175, 80, 0.2) 0%, rgba(67, 160, 71, 0.2) 100%); border-color: rgba(76, 175, 80, 0.4); color: #a5d6a7;">Database berhasil dibersihkan!</div>
  {% endif %}
  {% if request.query_params.get("msg") == "error_clear" %}
    <div class="alert">Terjadi kesalahan saat membersihkan database.</div>
  {% endif %}
  
  <h3>ğŸª Informasi Toko</h3>
  <form id="settings-form" method="post" action="/settings" class="form" onsubmit="return handleUpdateSettings(event)">
    <label for="store-name">Nama Toko</label>
    <input type="text" id="store-name" name="store_name" value="{{ settings.store_name }}" required>

    <label for="store-address">Alamat Toko</label>
    <textarea id="store-address" name="store_address">{{ settings.store_address }}</textarea>

    <label for="store-phone">Telepon Toko</label>
    <input type="text" id="store-phone" name="store_phone" value="{{ settings.store_phone }}">

    <button type="submit">ğŸ’¾ Simpan Pengaturan</button>
  </form>

  <h3 style="margin-top: 30px; color: var(--accent-color);">â° Pengaturan Zona Waktu</h3>
  <div class="timezone-card">
    <div class="timezone-info">
      <strong style="color: var(--text-secondary); font-size: 0.85rem;">Waktu Saat Ini</strong>
      <p id="current-time" style="font-weight: 600; font-size: 1.2rem; color: var(--accent-color); margin: 8px 0 0 0;"></p>
    </div>
    <form method="post" action="/settings" class="form" onsubmit="return handleUpdateSettings(event)">
      <input type="hidden" name="store_name" value="{{ settings.store_name }}">
      <input type="hidden" name="store_address" value="{{ settings.store_address }}">
      <input type="hidden" name="store_phone" value="{{ settings.store_phone }}">
      
      <label for="timezone">Pilih Zona Waktu Indonesia</label>
      <select id="timezone" name="timezone" required class="timezone-select">
        <option value="WIB" {% if settings.timezone == "WIB" %}selected{% endif %}>WIB - Waktu Indonesia Barat (UTC+7)</option>
        <option value="WITA" {% if settings.timezone == "WITA" %}selected{% endif %}>WITA - Waktu Indonesia Tengah (UTC+8)</option>
        <option value="WIT" {% if settings.timezone == "WIT" %}selected{% endif %}>WIT - Waktu Indonesia Timur (UTC+9)</option>
      </select>
      
      <small style="color: var(--text-secondary); margin-top: 8px; display: block; font-size: 0.8rem;">
        ğŸ’¡ Semua waktu pada struk, laporan, dan transaksi akan otomatis menyesuaikan dengan zona waktu yang dipilih.
      </small>
      
      <button type="submit" class="timezone-button">ğŸ’¾ Simpan Zona Waktu</button>
    </form>
  </div>

  <div class="card" style="margin-top: 30px;">
    <h2>ğŸ”’ Pengaturan Akun</h2>
    {% if request.query_params.get("msg") == "display_name_updated" %}
      <div class="alert" style="background: linear-gradient(135deg, rgba(76, 175, 80, 0.2) 0%, rgba(67, 160, 71, 0.2) 100%); border-color: rgba(76, 175, 80, 0.4); color: #a5d6a7;">Nama kasir berhasil diperbarui!</div>
    {% endif %}
    <form method="post" action="/settings/update_display_name" class="form" onsubmit="return handleUpdateDisplayName(event)">
      <label for="display-name">Nama Kasir (untuk Struk/Laporan)</label>
      <input type="text" id="display-name" name="new_display_name" value="{{ user.display_name if user.display_name else user.username }}" required>

      <button type="submit">ğŸ’¾ Update Nama Kasir</button>
    </form>
  </div>

  <div class="card" style="margin-top: 20px; border: 2px solid rgba(255, 235, 59, 0.6);">
    <h2 style="color: #fdd835;">ğŸ’¾ Backup & Restore Database</h2>
    <p style="color: var(--text-secondary); margin-bottom: 12px; font-size: 0.85rem;">
      Gunakan fitur ini untuk menyimpan semua data (produk, transaksi, dll) ke file, dan mengembalikannya lagi saat diperlukan.
    </p>
    <div class="form" style="gap: 12px;">
      <a href="/settings/export_db" class="btn btn-warning" style="width: 100%; padding: 10px 16px; text-align: center;">
        â¬‡ï¸ Export Database (Backup)
      </a>
      <form method="post" action="/settings/import_db" enctype="multipart/form-data" onsubmit="return handleImportDatabase(event)" style="display:flex; flex-direction:column; gap:8px;">
        <label for="db-file" style="font-size:0.85rem; color:var(--text-secondary);">Import Database (.db / .sqlite)</label>
        <input type="file" id="db-file" name="file" accept=".db,.sqlite,.sqlite3" required class="db-file-input">
        <button type="submit" class="btn-warning" style="padding: 10px 16px; font-size: 0.85rem;">
          â¬†ï¸ Import Database (Replace)
        </button>
        <small style="font-size:0.8rem; color:var(--text-secondary);">
          Import akan mengganti database saat ini dengan file yang diupload. Pastikan file backup benar.
        </small>
      </form>
    </div>
  </div>

  <div class="card" style="margin-top: 20px; border: 2px solid rgba(229, 57, 53, 0.4);">
    <h2 style="color: #ffcdd2;">âš ï¸ Database Management</h2>
    <p style="color: var(--text-secondary); margin-bottom: 20px; font-size: 0.85rem;">
      Hati-hati! Tindakan ini akan menghapus semua data dari database termasuk produk, transaksi, dan pengaturan.
    </p>
    <form method="post" action="/settings/clear_database" id="clear-database-form" onsubmit="return handleClearDatabase(event)">
      <button type="submit" class="btn-danger" style="width: 100%; padding: 12px 20px; font-size: 0.9rem;">
        ğŸ—‘ï¸ Clear Database (Hapus Semua Data)
      </button>
    </form>
  </div>
</div>

<script>
// Update waktu saat ini setiap detik dengan offset yang dipilih
function updateCurrentTime() {
  const timezone = document.getElementById('timezone').value || 'WIB';
  const tzOffsets = { 'WIB': 7, 'WITA': 8, 'WIT': 9 };
  const offset = tzOffsets[timezone] || 7;
  
  // Hitung waktu UTC + offset
  const now = new Date();
  const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
  const localTime = new Date(utc + (3600000 * offset));
  
  const options = {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit',
    hour12: false
  };
  
  const formatter = new Intl.DateTimeFormat('id-ID', options);
  const formatted = formatter.format(localTime);
  
  document.getElementById('current-time').textContent = formatted + ' (' + timezone + ')';
}

// Update saat halaman load dan setiap detik
if (document.getElementById('current-time')) {
  updateCurrentTime();
  setInterval(updateCurrentTime, 1000);
  
  // Update juga saat timezone berubah
  const tzSelect = document.getElementById('timezone');
  if (tzSelect) {
    tzSelect.addEventListener('change', updateCurrentTime);
  }
}
</script>
{% endblock %}